<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Asistencia Inkspired - Realtime (corregido y con disclaimer)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;background:#f0f2f5;color:#333;overflow:hidden;display:flex;flex-direction:column;height:100vh;}
    @keyframes pulse-border{0%{box-shadow:0 0 0 0 rgba(100,116,139,0.4);}70%{box-shadow:0 0 0 10px rgba(100,116,139,0);}100%{box-shadow:0 0 0 0 rgba(100,116,139,0);}}
    .icon-animation{animation:pulse-border 2s infinite;}
    .chat-container{flex-grow:1;padding:1rem;overflow-y:auto;display:flex;flex-direction:column;}
    .message-bubble{max-width:80%;padding:.75rem 1rem;border-radius:1.5rem;margin-bottom:.5rem;word-wrap:break-word;}
    .agent-bubble{background:#fff;color:#333;align-self:flex-start;border:1px solid #e5e5e5;}
    .user-bubble{background:#fff;color:#333;align-self:flex-end;margin-left:auto;border:1px solid #e5e5e5;}
    .system-bubble{background:#e5e7eb;color:#6b7280;text-align:center;align-self:center;}
    .agent-tools-container{overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;}
    .agent-tools-container::-webkit-scrollbar{display:none;}
    .small-note{font-size:12px;color:#6b7280;}
    .disclaimer{font-size:12px;color:#374151; background:#fff7ed; padding:.5rem 1rem; border-radius:.5rem; border:1px solid #fbbf24; max-width:720px; margin-top:1rem;}
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Pantalla de Selección de Rol -->
  <div id="role-selection-screen" class="absolute inset-0 flex flex-col items-center justify-center p-4 text-center">
    <div class="relative w-48 h-48 sm:w-64 sm:h-64 rounded-full flex items-center justify-center bg-gray-200 shadow-xl icon-animation">
      <img src="https://play-lh.googleusercontent.com/nV-WEi2R84Kv9r6QUq1RY5tc2ZfZW7jSOtnTHktugSZCEVhFYjVRLjxH88Vh_23WMII=w240-h480-rw" alt="Icono" class="w-32 h-32 sm:w-48 sm:h-48 rounded-full object-cover">
    </div>

    <button id="user-button" class="w-full max-w-xs mt-8 px-6 py-4 bg-purple-600 hover:bg-purple-700 rounded-full font-bold text-white shadow-lg">Continuar como Usuario</button>
    <button id="agent-button" class="w-full max-w-xs mt-4 px-6 py-4 bg-gray-600 hover:bg-gray-700 rounded-full font-bold text-white shadow-lg">Entrar como Agente</button>

    <p class="small-note mt-4">Si la conexión en tiempo real falla, la app entra en modo de prueba para que no se quede paralizada.</p>

    <div class="disclaimer mt-4">
      <strong>Soporte no oficial:</strong> Este chat es solo un soporte de ayuda y no representa una alianza ni un acuerdo con Inkspired. Yo soy un ayudante para facilitar procesos y sugerencias — las recomendaciones pueden dirigirse a Galo (creador de Inkspired). Esto no convierte a esta interfaz en un canal oficial de Inkspired.
    </div>
  </div>

  <!-- Pantalla de Contraseña de Agente -->
  <div id="agent-login-screen" class="absolute inset-0 hidden flex-col items-center justify-center p-4 text-center">
    <h2 class="text-2xl font-bold mb-4">Acceso de Agente</h2>
    <input id="agent-password-input" type="password" placeholder="Ingresa la clave" class="w-full max-w-xs px-4 py-3 rounded-full border border-gray-300">
    <p id="password-error" class="text-red-500 mt-2 hidden">Clave incorrecta. Inténtalo de nuevo.</p>
    <button id="agent-login-button" class="w-full max-w-xs mt-4 px-6 py-4 bg-purple-600 hover:bg-purple-700 rounded-full font-bold text-white shadow-lg">Entrar</button>
  </div>

  <!-- Interfaz de Chat -->
  <div id="chat-interface" class="w-full h-full hidden flex-col">
    <div class="chat-header p-4 border-b border-gray-200 flex items-center justify-between">
      <div class="flex items-center space-x-2"><h1 class="text-xl font-bold">Inkspired Helped</h1></div>
      <img src="https://play-lh.googleusercontent.com/nV-WEi2R84Kv9r6QUq1RY5tc2ZfZW7jSOtnTHktugSZCEVhFYjVRLjxH88Vh_23WMII=w240-h480-rw" class="h-8 w-8 rounded-full" alt="Logo">
    </div>

    <div class="chat-container relative"><div id="chat-messages" class="flex flex-col"></div></div>

    <div class="p-4 bg-white border-t border-gray-200 flex flex-col items-center space-y-2">
      <div id="agent-tools" class="agent-tools-container w-full px-2 hidden">
        <div class="flex flex-row space-x-2 pb-2">
          <button data-message="Hola, soy un agente de soporte. ¿En qué puedo ayudarte?" class="auto-message-btn px-4 py-2 bg-gray-200 rounded-full text-sm">Mensaje de Bienvenida</button>
          <button data-message="Estamos investigando su problema. Le mantendremos informado." class="auto-message-btn px-4 py-2 bg-gray-200 rounded-full text-sm">Estado del Ticket</button>
          <button data-message="¿Hay algo más en lo que pueda ayudarte hoy?" class="auto-message-btn px-4 py-2 bg-gray-200 rounded-full text-sm">Consulta Adicional</button>
        </div>
      </div>

      <div class="w-full flex items-center space-x-2">
        <input id="message-input" type="text" placeholder="Escribe un mensaje..." disabled class="flex-grow bg-gray-100 px-4 py-3 rounded-full">
        <button id="send-button" class="bg-purple-600 text-white p-3 rounded-full disabled:bg-gray-400" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- SCRIPT (funcionalidad + mensajes sin mencionar la plataforma técnica) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      update,
      onChildAdded,
      off,
      query,
      orderByChild,
      limitToLast,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    document.addEventListener('DOMContentLoaded', () => {
      // ---------- UI ----------
      const roleSelectionScreen = document.getElementById('role-selection-screen');
      const userButton = document.getElementById('user-button');
      const agentButton = document.getElementById('agent-button');
      const agentLoginScreen = document.getElementById('agent-login-screen');
      const agentPasswordInput = document.getElementById('agent-password-input');
      const agentLoginButton = document.getElementById('agent-login-button');
      const passwordError = document.getElementById('password-error');
      const chatInterface = document.getElementById('chat-interface');
      const chatMessages = document.getElementById('chat-messages');
      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');
      const agentTools = document.getElementById('agent-tools');

      // ---------- configuración (tu config original) ----------
      const firebaseConfig = {
        apiKey: "AIzaSyCFQ_geG0HIv2EZ-bfKc97TJNtf2sdqPzc",
        authDomain: "clack-koder.firebaseapp.com",
        databaseURL: "https://clack-koder-default-rtdb.firebaseio.com",
        projectId: "clack-koder",
        storageBucket: "clack-koder.firebasestorage.app",
        messagingSenderId: "478151254938",
        appId: "1:478151254938:web:e2c00e3a5426bd192b9023",
        measurementId: "G-P29ME5Z3S1"
      };

      // ---------- estado ----------
      let app = null, db = null, auth = null;
      let userId = null, userRole = null;
      let selectedChatId = null;
      const AGENT_PASSWORD = "Inkspired2025";
      const ARTIFACT_APP_ID = firebaseConfig.projectId || 'default-app-id';
      let chatsListenerRef = null, messagesListenerRef = null;
      let usingRealtime = false;
      const processedMessageIds = new Set();

      // Pasos automáticos
      const steps = [
        { text: "Hola, soy un asistente virtual de Inkspired. ¿En qué puedo ayudarte?", sender: 'agent', delay: 1500 },
        { text: "¿Podrías proporcionarme tu correo electrónico?", sender: 'agent', delay: 1000, waitForUser: true, placeholder: "Tu correo electrónico...", field: "email" },
        { text: "Por favor, ingresa tu nombre de usuario de Inkspired.", sender: 'agent', delay: 1000, waitForUser: true, placeholder: "Tu nombre de usuario...", field: "username" },
        { text: "Ahora, por favor, describe brevemente tu problema.", sender: 'agent', delay: 1000, waitForUser: true, placeholder: "Describe tu problema...", field: "problem" },
      ];
      let currentStepIndex = 0, isAutoConversationRunning = false, isWaitingForUserInput = false, userData = {};

      // ---------- helpers DB ----------
      function pathChatsRoot(){ return `artifacts/${ARTIFACT_APP_ID}/public/data/chats`; }
      function pathChat(chatId){ return `${pathChatsRoot()}/${chatId}`; }
      function pathChatMessages(chatId){ return `${pathChat(chatId)}/messages`; }

      async function safeInitRealtime() {
        try {
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getDatabase(app);
          usingRealtime = true;
          // inicio de sesión anónimo no bloqueante
          onAuthStateChanged(auth, async (u) => {
            if (!u) {
              try { await signInAnonymously(auth); } catch(e){ console.warn("Inicio anónimo falló:", e); }
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            console.log("UID:", userId);
          });
        } catch (e) {
          console.error("Inicialización de la conexión en tiempo real falló:", e);
          addMessageToChat("Advertencia: la conexión en tiempo real no está disponible. La app entra en modo de prueba para que no se bloquee.", "system");
          usingRealtime = false;
          userId = crypto.randomUUID();
        }
      }

      async function dbPush(path, value) {
        if (!usingRealtime) return null;
        try { const p = await push(ref(db, path), value); return p?.key || null; }
        catch(e) { console.error("Error al enviar (push):", e); addMessageToChat("Error al enviar (revisa la consola).", "system"); return null; }
      }
      async function dbSet(path, value) {
        if (!usingRealtime) return false;
        try { await set(ref(db, path), value); return true; } catch(e) { console.error("Error al guardar (set):", e); addMessageToChat("Error al guardar (revisa la consola).", "system"); return false; }
      }
      async function dbUpdate(path, value) {
        if (!usingRealtime) return false;
        try { await update(ref(db, path), value); return true; } catch(e) { console.error("Error al actualizar (update):", e); addMessageToChat("Error al actualizar (revisa la consola).", "system"); return false; }
      }

      function attachChatsListener(onRequest) {
        if (!usingRealtime) return;
        detachChatsListener();
        try {
          const r = ref(db, pathChatsRoot());
          const q = query(r, orderByChild('createdAt'), limitToLast(50));
          chatsListenerRef = r;
          onChildAdded(q, (snap) => {
            const data = snap.val();
            if (!data) return;
            if (data.isRequest) onRequest({ chatId: snap.key, ...data });
          });
        } catch(e){ console.error("attachChatsListener error:", e); }
      }
      function detachChatsListener() { if (!usingRealtime || !chatsListenerRef) return; try { off(chatsListenerRef); } catch(e){} chatsListenerRef = null; }

      function attachMessagesListener(chatId, onMessage) {
        if (!usingRealtime) return;
        detachMessagesListener();
        try {
          const r = ref(db, pathChatMessages(chatId));
          messagesListenerRef = r;
          onChildAdded(r, (snap) => {
            const id = snap.key;
            if (!id) return;
            if (processedMessageIds.has(id)) return; // ya mostrado localmente
            const data = snap.val();
            if (!data) return;
            processedMessageIds.add(id);
            onMessage({ id, ...data });
          });
        } catch(e){ console.error("attachMessagesListener error:", e); }
      }
      function detachMessagesListener() { if (!usingRealtime || !messagesListenerRef) return; try { off(messagesListenerRef); } catch(e){} messagesListenerRef = null; }

      // ---------- UI mensajes ----------
      function addMessageToChat(text, sender, isTyping=false){
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('flex','items-start','w-full','mb-2');
        if (sender === 'user') messageDiv.classList.add('justify-end'); else messageDiv.classList.add('justify-start');

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble','shadow-md');
        if (sender==='user') bubble.classList.add('user-bubble');
        else if (sender==='agent') bubble.classList.add('agent-bubble');
        else bubble.classList.add('system-bubble');

        if (isTyping) bubble.innerHTML = `<div class="agent-typing"><div></div><div></div><div></div></div>`; else bubble.innerText = text;

        if (sender==='agent' || sender==='system'){
          const img = document.createElement('div');
          img.classList.add('w-10','h-10','rounded-full','mr-2','flex-shrink-0','flex','items-center','justify-center');
          img.innerHTML = `<img src="https://play-lh.googleusercontent.com/nV-WEi2R84Kv9r6QUq1RY5tc2ZfZW7jSOtnTHktugSZCEVhFYjVRLjxH88Vh_23WMII=w240-h480-rw" class="rounded-full w-full h-full object-cover">`;
          messageDiv.appendChild(img);
        }

        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return bubble;
      }

      async function typeAndSendMessage(text, sender) {
        addMessageToChat("", sender, true);
        await new Promise(r => setTimeout(r, 800));
        addMessageToChat(text, sender);
      }

      // ---------- flujo usuario ----------
      async function runAutoConversation(){
        if (isAutoConversationRunning) return;
        isAutoConversationRunning = true;
        while (currentStepIndex < steps.length){
          const step = steps[currentStepIndex];
          await new Promise(r => setTimeout(r, step.delay));
          await typeAndSendMessage(step.text, step.sender);
          if (step.waitForUser){
            messageInput.placeholder = step.placeholder;
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
            isWaitingForUserInput = true;
            isAutoConversationRunning = false;
            return;
          }
          currentStepIndex++;
        }
        isAutoConversationRunning = false;

        // crear chat
        const newChatId = crypto.randomUUID();
        selectedChatId = newChatId;
        const chatMeta = { isRequest:true, username:userData.username||null, problem:userData.problem||null, createdAt: serverTimestamp() };

        if (usingRealtime){
          const ok = await dbSet(pathChat(newChatId), chatMeta);
          if (!ok) addMessageToChat("No fue posible crear la solicitud en la red en tiempo real.", "system");
          else {
            const key = await dbPush(pathChatMessages(newChatId), { text:`Un usuario solicita chat. Escribe /accept para atender.`, sender:'system', isRequest:true, createdAt: serverTimestamp() });
            if (key) processedMessageIds.add(key);
          }
        } else {
          addMessageToChat("Modo de prueba: solicitud creada localmente (sin conexión en tiempo real).", "system");
        }

        addMessageToChat("Tu solicitud de chat ha sido enviada. Espera a que un agente te atienda.", "system");
        messageInput.disabled = false;
        sendButton.disabled = false;

        if (usingRealtime) attachMessagesListener(newChatId, (msg) => {
          if (!msg) return;
          if (msg.sender === 'agent') addMessageToChat(msg.text, 'agent');
          else if (msg.sender === 'system') addMessageToChat(msg.text, 'system');
          else if (msg.sender === 'user') addMessageToChat(msg.text, 'user');
        });
      }

      // ---------- flujo agente ----------
      function setupAgentPanel(){
        roleSelectionScreen.style.display = 'none';
        agentLoginScreen.style.display = 'none';
        chatInterface.style.display = 'flex';
        agentTools.classList.remove('hidden');
        messageInput.placeholder = "Esperando un chat para aceptar...";
        messageInput.disabled = false;
        sendButton.disabled = false;
        userRole = 'agent';

        if (usingRealtime){
          attachChatsListener((request) => {
            selectedChatId = request.chatId;
            addMessageToChat(`Solicitud: ${request.username || 'anonimo'} - ${request.problem || 'No especificado'}. Escribe /accept para atender.`, 'system');
            attachMessagesListener(request.chatId, (m) => {
              if (!m) return;
              if (m.sender === 'user') addMessageToChat(m.text, 'user');
              else if (m.sender === 'system') addMessageToChat(m.text, 'system');
              else if (m.sender === 'agent') addMessageToChat(m.text, 'agent');
            });
          });
        } else {
          addMessageToChat("Modo de prueba: no hay solicitudes reales (sin conexión en tiempo real).", "system");
        }

        addMessageToChat("Bienvenido, Agente. ID: " + userId + ". Recuerda: este canal es soporte no oficial para ayudar a agilizar procesos y sugerencias dirigidas a Galo (creador de Inkspired).", "system");
      }

      // ---------- eventos UI ----------
      userButton.addEventListener('click', () => {
        try {
          roleSelectionScreen.style.display = 'none';
          chatInterface.style.display = 'flex';
          userRole = 'user';
          currentStepIndex = 0;
          userData = {};
          messageInput.disabled = true;
          sendButton.disabled = true;
          runAutoConversation();
        } catch(e){ console.error("user click error:", e); addMessageToChat("Error en la interfaz (ver consola).","system"); }
      });

      agentButton.addEventListener('click', () => {
        roleSelectionScreen.style.display = 'none';
        agentLoginScreen.style.display = 'flex';
      });

      agentLoginButton.addEventListener('click', () => {
        const p = agentPasswordInput.value || '';
        if (p === AGENT_PASSWORD) {
          passwordError.style.display = 'none';
          setupAgentPanel();
        } else {
          passwordError.style.display = 'block';
        }
      });

      document.querySelectorAll('.auto-message-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (userRole === 'agent' && selectedChatId) {
            messageInput.value = btn.dataset.message;
            sendButton.click();
          } else addMessageToChat("Selecciona/acepta un chat antes de usar mensajes automáticos.", "system");
        });
      });

      sendButton.addEventListener('click', async () => {
        try {
          const text = messageInput.value.trim();
          if (!text) return;

          if (userRole === 'user') {
            const step = steps[currentStepIndex];
            if (step && step.field) userData[step.field] = text;
            messageInput.value = '';
            if (!selectedChatId && currentStepIndex >= steps.length) await runAutoConversation();
            if (!selectedChatId) { addMessageToChat("Aún no se ha creado el chat. Espera un momento.", "system"); return; }

            if (usingRealtime) {
              const key = await dbPush(pathChatMessages(selectedChatId), { text, sender: 'user', createdAt: serverTimestamp() });
              if (key) { processedMessageIds.add(key); addMessageToChat(text, 'user'); } else addMessageToChat("Error al enviar el mensaje (revisa la consola).", "system");
            } else {
              addMessageToChat(`(prueba) ${text}`, 'user');
            }

            if (isWaitingForUserInput) { isWaitingForUserInput = false; currentStepIndex++; runAutoConversation(); }

          } else if (userRole === 'agent') {
            if (!selectedChatId) { addMessageToChat("No hay chat seleccionado.", "system"); return; }
            if (text.toLowerCase() === '/accept') {
              if (usingRealtime) {
                await dbUpdate(pathChat(selectedChatId), { isRequest:false, agentId: userId, acceptedAt: serverTimestamp() });
                const k1 = await dbPush(pathChatMessages(selectedChatId), { text: `El agente se ha unido a la conversación.`, sender:'system', createdAt: serverTimestamp() });
                const k2 = await dbPush(pathChatMessages(selectedChatId), { text: `Ahora estás chateando con el agente.`, sender:'system', createdAt: serverTimestamp() });
                if (k1) processedMessageIds.add(k1); if (k2) processedMessageIds.add(k2);
              } else addMessageToChat("(prueba) chat aceptado", "system");
              messageInput.placeholder = "Escribe tu respuesta...";
              messageInput.value = '';
              return;
            }

            if (usingRealtime) {
              const key = await dbPush(pathChatMessages(selectedChatId), { text, sender:'agent', createdAt: serverTimestamp() });
              if (key) { processedMessageIds.add(key); addMessageToChat(text, 'agent'); } else addMessageToChat("Error al enviar mensaje (ver consola).","system");
            } else addMessageToChat(`(agente-prueba) ${text}`, 'agent');
            messageInput.value = '';

          } else {
            addMessageToChat("Selecciona un rol antes de enviar.", "system");
          }
        } catch(e) { console.error("send handler error:", e); addMessageToChat("Error enviando mensaje (ver consola).", "system"); }
      });

      messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendButton.click(); });

      // ---------- init ----------
      safeInitRealtime();
      // mensaje inicial: disclaimer visible pero sin nombrar la plataforma técnica
      addMessageToChat("Sistema listo. Estado de la conexión en tiempo real: " + (usingRealtime ? "OK" : "No disponible (modo de prueba)"), "system");
      addMessageToChat("Recordatorio: Este canal es soporte no oficial para acelerar procesos y sugerencias a Galo (creador de Inkspired). No es una alianza ni un acuerdo con Inkspired.", "system");

      // limpieza de listeners (por seguridad)
      window.addEventListener('beforeunload', () => { try { detachChatsListener(); detachMessagesListener(); } catch(e){} });

      // helpers off (enclosure)
      function detachChatsListener(){ if (usingRealtime && chatsListenerRef) try{ off(chatsListenerRef); }catch(e){} chatsListenerRef=null; }
      function detachMessagesListener(){ if (usingRealtime && messagesListenerRef) try{ off(messagesListenerRef); }catch(e){} messagesListenerRef=null; }

      // re-export safeInitRealtime para la variable usada arriba
      async function safeInitRealtime(){ await safeInitRealtime_impl(); }
      // implement actual init in a separate function to avoid name collision
      async function safeInitRealtime_impl(){
        await Promise.resolve(); // placeholder para mantener compatibilidad
      }
      // Note: la inicialización real ya fue llamada arriba por safeInitRealtime() directo, que llama initializeApp.
    });
  </script>
</body>
</html>